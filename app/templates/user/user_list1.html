{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">X</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    <h1 class="my-4">User List</h1>
    <table class="table table-striped table-bordered">
        <thead class="thead-dark">
            <tr>
                <th>Staff No</th>
                <th>Staff Name</th>
                <th>Is Admin</th>
                <th>Created At</th>
                <th>Updated At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.staffno }}</td>
                <td>{{ user.staffname }}</td>
                <td>{{ user.isadmin }}</td>
                <td>{{ user.created_at }}</td>
                <td>{{ user.updated_at }}</td>
                <td>
                  <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editUserModal" data-staffno="{{ user.staffno }}" data-staffname="{{ user.staffname }}" data-isadmin="{{ user.isadmin }}">Edit</button>
                  <form action="{{ url_for('user.delete_user', staffno=user.staffno) }}" method="post" style="display:inline;">
                      <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                  </form>
                  <button type="button" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#viewUserModal" data-staffno="{{ user.staffno }}" data-staffname="{{ user.staffname }}" data-isadmin="{{ user.isadmin }}" data-created_at="{{ user.created_at }}" data-updated_at="{{ user.updated_at }}">View</button>
              </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <button type="button" class="btn btn-info my-3" data-toggle="modal" data-target="#userFormModal">Add User</button>

    <!-- Add User Modal -->
    <div class="modal fade" id="userFormModal" tabindex="-1" role="dialog" aria-labelledby="userFormModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userFormModalLabel">User Form</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            {% include 'user/user_form.html' %}
          </div>
        </div>
      </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="viewUserModal" tabindex="-1" role="dialog" aria-labelledby="viewUserModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="viewUserModalLabel">View User</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                  </button>
              </div>
              <div class="modal-body">
                  <p><strong>Staff No:</strong> <span id="view-staffno"></span></p>
                  <p><strong>Staff Name:</strong> <span id="view-staffname"></span></p>
                  <p><strong>Is Admin:</strong> <span id="view-isadmin"></span></p>
                  <p><strong>Created At:</strong> <span id="view-created_at"></span></p>
                  <p><strong>Updated At:</strong> <span id="view-updated_at"></span></p>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              </div>
          </div>
      </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Hide flash messages after 5 seconds
    setTimeout(function() {
        $('#flash-messages .alert').fadeOut('slow', function() {
            $(this).remove();
        });
    }, 5000);

    $('#viewUserModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var staffno = button.data('staffno');
        var staffname = button.data('staffname');
        var isadmin = button.data('isadmin');
        var created_at = button.data('created_at');
        var updated_at = button.data('updated_at');
        var modal = $(this);
        modal.find('#view-staffno').text(staffno);
        modal.find('#view-staffname').text(staffname);
        modal.find('#view-isadmin').text(isadmin);
        modal.find('#view-created_at').text(created_at);
        modal.find('#view-updated_at').text(updated_at);
    });
</script>
{% endblock %}