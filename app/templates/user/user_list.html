{% extends "base.html" %}

{% block content %}
<h1 class="my-4">User List</h1>
<table class="table table-striped table-bordered">
    <thead class="thead-dark">
        <tr>
            <th>Staff No</th>
            <th>Staff Name</th>
            <th>Is Admin</th>
            <th>Created At</th>
            <th>Updated At</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for user in users %}
        <tr>
            <td>{{ user.staffno }}</td>
            <td>{{ user.staffname }}</td>
            <td>{{ user.isadmin }}</td>
            <td>{{ user.created_at }}</td>
            <td>{{ user.updated_at }}</td>
            <td>
                <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editUserModal" data-staffno="{{ user.staffno }}" data-staffname="{{ user.staffname }}" data-isadmin="{{ user.isadmin }}">Edit</button>
                <form action="{{ url_for('user.delete_user', staffno=user.staffno) }}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>
                <button type="button" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#viewUserModal" data-staffno="{{ user.staffno }}" data-staffname="{{ user.staffname }}" data-isadmin="{{ user.isadmin }}" data-created_at="{{ user.created_at }}" data-updated_at="{{ user.updated_at }}">View</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<button type="button" class="btn btn-info my-3" data-toggle="modal" data-target="#userFormModal">Add User</button>

<!-- Add User Modal -->
<div class="modal fade" id="userFormModal" tabindex="-1" role="dialog" aria-labelledby="userFormModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userFormModalLabel">User Form</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        {% include 'user/user_form.html' %}
      </div>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="editUserForm" method="post">
          <!-- Form fields will be populated by JavaScript -->
        </form>
      </div>
    </div>
  </div>
</div>

<!-- View User Modal -->
<div class="modal fade" id="viewUserModal" tabindex="-1" role="dialog" aria-labelledby="viewUserModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewUserModalLabel">View User</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="viewUserForm">
          <!-- Form fields will be populated by JavaScript -->
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    $('#editUserModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var staffno = button.data('staffno');
        var staffname = button.data('staffname');
        var isadmin = button.data('isadmin');

        var modal = $(this);
        var form = modal.find('#editUserForm');
        form.attr('action', '/user/edit/' + staffno);
        form.html(`
            <div class="form-group">
                <label for="staffno">Staff No</label>
                <input type="text" class="form-control" id="staffno" name="staffno" value="${staffno}" readonly>
            </div>
            <div class="form-group">
                <label for="staffname">Staff Name</label>
                <input type="text" class="form-control" id="staffname" name="staffname" value="${staffname}">
            </div>
            <div class="form-group">
                <label for="isadmin">Is Admin</label>
                <input type="checkbox" class="form-control" id="isadmin" name="isadmin" ${isadmin ? 'checked' : ''}>
            </div>
            <button type="submit" class="btn btn-primary">Save changes</button>
        `);
    });

    $('#viewUserModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var staffno = button.data('staffno');
        var staffname = button.data('staffname');
        var isadmin = button.data('isadmin');
        var created_at = button.data('created_at');
        var updated_at = button.data('updated_at');

        var modal = $(this);
        var form = modal.find('#viewUserForm');
        form.html(`
            <div class="form-group">
                <label for="staffno">Staff No</label>
                <input type="text" class="form-control" id="staffno" name="staffno" value="${staffno}" readonly>
            </div>
            <div class="form-group">
                <label for="staffname">Staff Name</label>
                <input type="text" class="form-control" id="staffname" name="staffname" value="${staffname}" readonly>
            </div>
            <div class="form-group">
                <label for="isadmin">Is Admin</label>
                <input type="checkbox" class="form-control" id="isadmin" name="isadmin" ${isadmin ? 'checked' : ''} disabled>
            </div>
            <div class="form-group">
                <label for="created_at">Created At</label>
                <input type="text" class="form-control" id="created_at" name="created_at" value="${created_at}" readonly>
            </div>
            <div class="form-group">
                <label for="updated_at">Updated At</label>
                <input type="text" class="form-control" id="updated_at" name="updated_at" value="${updated_at}" readonly>
            </div>
        `);
    });
});
</script>
{% endblock %}

